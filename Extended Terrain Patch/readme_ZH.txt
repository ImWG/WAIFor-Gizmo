========================================================

        扩展地形MOD（Extended Terrains Mod）1.1
             By 我是谁004（WAIFor），2018

========================================================


关于
===================================
这是一个修改了EXE并用DLL注入的《帝国时代2：征服者》MOD。在这个游戏中，您可
以体验多达26种新地形，且它们均可以在实战中正常地工作。
将压缩包中Games\下的文件解压至游戏目录下，运行age2_newter.exe，就可以开始
这个MOD了。wndmode.dll是使游戏窗口化的库，如果目录下或age2_x1\下已经有该文
件，则不需要解压。


背景
===================================
熟悉《帝国时代2：征服者》的MOD制作者都知道，在帝国2的DAT文件里，地形数量是
不可以任意增减的，只能保持41或42个，否则游戏便无法读取数据。即使是新增的第
42号地形，单位在其上的运动也不正常，会发生先被阻挡后又沿直线走入的现象。因
此，添加地形成为一个很艰难的问题，许多MOD都只能通过替代旧的不常用地形（如
隐藏草、至尊王路面）来实现增加新地形的功能。
在UserPatch 1.5中，新增了替换地形图像的功能，使得剧情和随机地图制作者可以
用自定义的地形SLP文件来临时替换原有的图像，从而模拟出新的地形。这是一个很
有创造性的功能，可以让地图编辑器更为自由。但对于MOD制作者而言，仅仅用这个
是不够的，因为只替换了图像，而没有改变地形间的过渡、地图颜色等。

为了允许游戏添加更多的地形，我对EXE程序进行了研究，发现在加载了所有42个地
形后，程序会继续读取一种叫“边界”的数据，但这些数据在游戏中从未被使用，因为
它们是旧版遗留下来的。除此之外，DAT文件中还有帝国1遗留的随机地图数据，这些
数据同样未被使用。而在读取了上述数据之后，游戏会直接跳过一定的数据长度，读
取接下来的部分。由此我想到，可以通过改变指令，增加程序要读取的地形数量，并
且跳过对边界的读取。同时把DAT的42个地形后的数据强制改写为新地形，从而达到
增加新地形效果。这就是我退出的《扩展地形MOD》的1.0版。
但这样的新地形会像42号地形那样，表现出奇怪的现象。由于没有地形限制数据，新
地形上单位的足迹是未知的，可能会像原版的“未知”地形那样，显示狂战士站立的图
像，或者显示其他图像。而建造建筑时，也会出现不确定能否在其上建造的问题。更
重要的是，因为游戏硬编码的缘故，单位在新地形上的运动是不正常的，旧地形也无
法通过修改DAT的地形限制来改变其类型。因此，在1.1版中，我们对程序指令做了进
一步的修改，让新地形有更好的表现。


内容与原理
===================================
在这个MOD中，除了原有的42个地形，还多出了25个取材自UserPatch的新地形，42号
地形也被改成了纯黑色地形。这些新地形除了在视觉上是独特的之外，其他属性均
“继承”于前41个地形，使用被继承地形的地形限制、足迹图像数据，因而无需为它们
设置新的地形限制属性。
在压缩包的ASM\文件夹下，包含了基于Gizmo的补丁DLL的源代码。其中指定了新地形
的数量、名称以及继承的地形，开发者可以通过阅读源码来理解补丁的原理，并修改
程序并编译，来制作自己的新地形补丁。
最重要的地形障碍类型，在程序中被分为3种：水域（船只可以行走）、陆地（陆上单
位可以行走）以及浅滩（二者均可行走）。这些属性会在游戏开始或者读取存档后写
入到内存中，因此游戏中改变地形（如放置桥梁）是无法改变障碍类型的。此外，前
41个地形的障碍属性位于EXE中，因而无法通过修改DAT来改变，42号地形也不能拥有
自己的类型。而在我们的设计中，设置障碍类型遇到新地形时，会参考所继承的地形，
所以能够获得合理的障碍类型。

在地图编辑器中添加的新地形选项的名称，可以有下述三种形式：
①直接字符串，即写在DLL中的字符串，需要将列表中的值设置为双字的字符串地址。
②语言DLL编号及后缀序号，如“农田 2”，需要设置第一个字为DLL编号，第三个字节
  为序号ID，第四个为01。如果序号为0，则不显示。
③语言DLL编号及类型，如“道路 (其他)”。需要将两个字分别指定为DLL编号。

在PHP\文件夹下，含有两个DAT文件：empires2_x1_p0.dat与new_terrains.dat，以及
一个PHP脚本terrain_merge.php。empires2_x1_p0.dat为MOD的原始DAT，只含有42个地
形和其他数据；而new_terrains.dat的地形数据中，除了第一个是原版的草地外，第2
到第26包含了25个新地形的数据。而PHP脚本的作用，便是将后者的新地形数据写入到
前者的地形之后，方便制作者使用。
PHP脚本在运行时，会将两个DAT文件解压，将后者的指定数量的地形覆盖到前者的数据，
然后再压缩生成新的empires2_x1_p1.dat。为了运行PHP，请使用WAMP套件或者单独的
PHP解释器。